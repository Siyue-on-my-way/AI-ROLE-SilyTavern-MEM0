# 业务设计：长期记忆（mem0）写入与检索增强

版本：v0.1（草案）  
更新时间：2025-12-28

## 1. 业务概览

本方案在 SillyTavern 现有对话链路中增加两条“旁路能力”：

- 写入链路：在聊天保存（落盘）时，把本轮对话以 `user_id + agent_id` 维度写入 mem0。
- 检索链路：在每次生成前，对 mem0 执行检索（含增强与 fallback），把召回的记忆注入到 prompt 的 system 段。

核心目标是提升跨天、跨上下文窗口的连续性，同时保持：
- mem0 不可用时，生成与保存不中断（静默降级）。
- 记忆隔离明确（用户隔离、角色隔离、群聊隔离）。

## 2. 业务对象与标识

### 2.1 身份维度

- `user_id`：SillyTavern 的用户标识（启用 accounts 时为 handle；未启用 accounts 时为默认用户）。
- `agent_id`：角色标识（建议优先 `char_name`，或使用角色聊天目录名作为稳定 id）。
- `run_id`：可选（本方案不强依赖，后续可用于一次会话周期的隔离）。

### 2.2 记忆类型（逻辑）

写入时不强制区分类型，但推荐在内容或 metadata 中体现：
- 偏好：饮食、称呼、禁忌、喜好
- 事实：用户经历、人物关系、设定细节
- 状态：情绪、近期事件（短期但可跨天）

## 3. 写入链路（Memory Add）

### 3.1 触发点

触发时机以“聊天保存”为准（避免把临时未保存的内容写入长期记忆）。

### 3.2 写入内容选择

建议写入“最近一轮”或“最近两轮”对话（例如最后 1 条 user + 最后 1 条 assistant）：
- 好处：粒度适中，便于 mem0 结构化提取；避免一次写入过长导致噪声。
- 风险：如果一次 assistant 输出包含多主题，可能产生无关记忆；后续可考虑按句拆分或增加过滤。

### 3.3 写入请求（REST）

- `POST /memories`
- Body：
  - `messages`: [{role, content}, ...]
  - `user_id`, `agent_id`
  - `metadata`：可选（chatfile、avatar_url、timestamp 等）

### 3.4 失败策略

- 写入失败不影响聊天保存：异步触发、记录告警（不包含敏感信息）。
- 超时控制：建议 1–2 秒，避免拖慢保存流程。

## 4. 检索链路（Memory Search + Query Enhancement）

### 4.1 触发点

在 SillyTavern 向模型发起生成前进行检索，作为 prompt 的一部分进入模型上下文。

### 4.2 弱问句问题定义

弱问句指缺少实体、指代不清、依赖上下文才能理解的问题，例如：
- “你今天有什么不一样？”
- “你还记得吗？”
- “那个事情后来怎么样？”

如果直接用该句作为向量检索 query，常见结果是：
- 命中随机相似的“变化/今天/感觉”类片段（噪声高）
- 或命中为空（query 信息量不足）

### 4.3 检索策略（分层 + fallback）

按成本从低到高依次尝试：

1) 原始检索（低成本）
- Query：最后一条 user 消息
- 目的：对明确问题直接命中

2) 上下文增强检索（fallback）
- Query：最近 N 条对话拼接（user/assistant）+ “User question: ...”
- 目的：把指代解析所需的上下文带入检索 query
- 约束：限制最大字符数（例如 1200），避免 query 过长

3) LLM 语义重写检索（可选，最高成本）
- 条件：前两次为空；且用户在设置中开启“语义重写”；且配置了重写 prompt
- 做法：把（user_question + recent_conversation）交给重写 prompt，让模型输出“自包含检索句”
- 再用该 rewritten query 调 mem0 `/search`
- 超时控制：建议 2–3 秒
- 成本控制：仅在 fallback 阶段触发

### 4.4 重写 prompt 的输入/输出契约

输入（建议以 JSON 传给模型，便于解析）：
- `user_name`
- `char_name`
- `user_question`
- `recent_conversation`

输出（强约束）：
- 只输出一条“改写后的 query 文本”
- 不要解释、不要引用符号、不要 markdown

### 4.5 记忆注入（Prompt Injection）

注入形式（示例）：

```
Relevant long-term memory:
- 用户喜欢被称呼为“小雨”
- 用户对海鲜过敏
- 上次对话提到周三要面试
```

注入位置：
- 优先追加到首条 `system` message；
- 若无 `system` message，则插入一条 `system`。

注入约束：
- 限制条数（例如 topK=5）
- 限制总长度（例如最多 800–1500 字符）
- 不应覆盖原有系统提示，只追加

### 4.6 失败策略

- mem0 不可用或超时：跳过检索注入，直接生成（静默降级）。
- 重写失败：跳过重写，保持 fallback 结果（即为空也可继续生成）。

## 5. 设置页（Prompt 管理）

### 5.1 UI 需求

在设置页增加“Mem0 Retrieval: Query Enhancement”区域：
- 开关：启用语义重写（LLM）
- 文本框：重写 prompt

### 5.2 生效范围

设置保存后，在下一次生成请求中生效（作为请求参数送到后端）。

## 6. 业务验收用例（最小集）

- 用例 A：明确问题
  - 输入：“我海鲜过敏，别推荐海鲜”
  - 若第二天问：“晚饭推荐什么？”
  - 应检索到“海鲜过敏”并避免推荐海鲜

- 用例 B：弱问句 + 上下文增强
  - 上下文：“我昨晚失眠了 …”
  - 输入：“你今天有什么不一样？”
  - 应在 Query2 中带上失眠上下文，检索到相关记忆

- 用例 C：弱问句 + 重写
  - Query1/2 都未命中时，启用重写
  - 重写输出应变为“结合最近对话：用户昨晚失眠，询问今天状态有何变化”
  - 再次检索命中并注入

