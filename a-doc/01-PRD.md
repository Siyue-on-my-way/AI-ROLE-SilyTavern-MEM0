# PRD：SillyTavern × mem0 长期记忆集成（微服务）

版本：v0.1（草案）  
更新时间：2025-12-28  
目标读者：产品/研发/运维

## 1. 背景与问题

SillyTavern 的“记忆”在默认形态下主要依赖聊天记录持久化与上下文拼接（以及可选的摘要/向量扩展）。当对话跨度较长或跨天时，模型在单次上下文窗口内无法携带所有历史细节，导致对用户偏好、经历、情绪等长期信息的记忆不稳定。

引入 mem0 的目标是提供独立的长期记忆服务（写入 + 检索），在不改变主要聊天界面的前提下，为生成请求提供可检索、可回忆的关键记忆片段。

## 2. 目标

- 在保持 SillyTavern 主要聊天 UI 不变的前提下，实现长期记忆能力接入。
- 以微服务方式部署：SillyTavern 与 mem0 各自独立运行，HTTP 通信。
- 统一 `docker/docker-compose.yaml` 管理所有服务启动，数据库组件共用一套。
- 支持“弱问句”场景：提供查询增强 + fallback；可选 LLM 重写增强，且重写 prompt 可在设置页管理。

## 3. 非目标（Out of Scope）

- 不实现 mem0 平台（OpenMemory UI/API）整套产品化能力，仅使用 mem0 OSS REST server 能力。
- 不改变 SillyTavern 的聊天记录格式与现有文件结构。
- 不引入新的前端交互流程（仅新增“设置项”允许）。

## 4. 用户与使用场景

### 4.1 角色

- 普通用户：与角色长期对话，希望角色能记住偏好、关系、经历等。
- 管理员/高级用户：希望可配置记忆检索策略、可开关、可调优。

### 4.2 核心场景

- 跨天对话：用户再次打开同一角色聊天，角色能回忆过去偏好与关键事件。
- 弱问句：用户发“有什么不一样”“你还记得吗”等缺少实体信息的问题，仍能借助上下文与重写检索到相关记忆。
- 多角色隔离：不同角色/群聊之间记忆隔离（不会串台）。

## 5. 需求范围（功能需求）

### 5.1 写入记忆（Memory Add）

- 在聊天“落盘/保存”时，将本轮对话（至少 user/assistant 的最近一轮）写入 mem0。
- 写入需包含隔离标识：
  - `user_id`：SillyTavern 用户（如 `request.user.profile.handle`）
  - `agent_id`：角色标识（建议使用 `char_name` 或角色文件夹名）
  - `metadata`：可选（chat 文件名、avatar_url、时间等）

### 5.2 检索记忆（Memory Search）

在每次 `/generate` 请求前对 mem0 发起检索，得到记忆条目并注入 prompt：

- Query 1（原始）：最后一条 user 消息
- Query 2（增强 fallback）：最近 N 条上下文拼接后的查询
- Query 3（可选重写）：若前两次为空，使用 LLM 将弱问句改写为自包含检索句，再检索

注入方式：
- 将记忆条目追加到首条 `system` prompt（或在没有 system 时插入一条 system）。

### 5.3 查询重写 prompt 管理（设置页）

在设置页提供一块专门的配置区域：

- 开关：是否启用“语义重写（LLM）”
- 文本框：可编辑的“重写 prompt”
- 约束：重写输出应仅为 query 文本（无解释、无引号、无 markdown）

### 5.4 微服务部署（统一 compose）

- SillyTavern：独立容器（默认 8000）
- mem0 REST server：独立容器（内部 8000，对外映射 8001 或按需）
- 数据库：共用一套组件
  - Postgres + pgvector（向量存储）
  - Neo4j（图存储）
- 统一由 `role_chat/docker/docker-compose.yaml` 启动与编排

## 6. 约束与原则

- 尽量不“爆改”上游：优先配置与外置服务方案；若需改动代码，保持 patch 小且可控。
- 前端界面不改变主要流程：仅新增设置项，且复用现有设置页样式/存储机制。
- 失败可用：mem0 不可用时不影响生成（检索失败应静默降级）。
- 低延迟：检索与重写需有超时控制（例如 1–2.5 秒）。

## 7. 非功能需求

- 稳定性：mem0/数据库异常时，SillyTavern 仍可正常聊天（不阻塞生成/保存）。
- 安全：API Key 不写入日志；容器间网络隔离；数据库持久化卷。
- 可观测：至少记录 mem0 调用失败与超时（不包含敏感内容）。
- 可升级：compose 与配置可独立演进；业务逻辑尽量独立于上游改动点。

## 8. 验收标准（Acceptance Criteria）

- 启动
  - `docker compose up -d` 能启动 SillyTavern、mem0、Postgres、Neo4j。
  - SillyTavern 在 `http://localhost:8000` 可用；mem0 在 `http://localhost:8001` 可访问。
- 写入
  - 发生聊天保存后，mem0 `/memories` 中可查到对应 `user_id + agent_id` 的记忆增长。
- 检索
  - 正常问题：能检索并注入记忆条目，模型回答体现对历史偏好的回忆。
  - 弱问句：在启用“增强+fallback”后命中率提升；启用“重写”后进一步提升。
- 配置
  - 设置页可编辑重写 prompt 与开关，保存后在下一次生成请求生效。

## 9. 风险与对策

- 风险：弱问句重写依赖 LLM，增加成本与延迟  
  对策：默认关闭；仅在 fallback 阶段调用；设置超时。
- 风险：记忆注入过多影响上下文长度  
  对策：限制条数/长度；必要时仅注入 topK。
- 风险：上游升级冲突  
  对策：尽量减少改动；改动集中在少数入口；记录改动点与兼容策略。

