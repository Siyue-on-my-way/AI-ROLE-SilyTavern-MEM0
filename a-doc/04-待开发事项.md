# 待开发事项：SillyTavern × mem0 长期记忆集成

版本：v0.1（草案）  
更新时间：2025-12-28

## 1. 里程碑

- M0：微服务可启动（compose 可用）
- M1：生成链路接入检索注入（Query1/2/3 + 降级）
- M2：保存链路接入写入记忆（异步 + 降级）
- M3：设置页增加“检索重写 prompt 管理”配置区
- M4：可观测与质量保障（日志、超时、基础测试）

## 2. 待开发事项清单

### 2.1 部署与运行

- 校验 `role_chat/docker/docker-compose.yaml` 端口/卷/依赖关系，补齐健康检查策略
- 统一环境变量管理（`.env` 示例仅本地使用，不纳入上游仓库）
- 明确数据卷结构与备份/迁移策略（Postgres/Neo4j/mem0 history/ST data）

### 2.2 生成链路（检索注入）

- 在 ST 的生成入口增加 mem0 检索调用开关与超时（默认关闭/静默降级）
- 实现 Query Enhancement + fallback：
  - Query1：last user message
  - Query2：recent context + question（长度限制）
  - Query3：LLM rewrite（可选，仅 fallback 阶段启用）
- 设计注入格式与上限控制（topK、总长度、去重策略）
- 明确隔离键映射规则（`user_id`、`agent_id`、群聊/多角色策略）

### 2.3 保存链路（写入记忆）

- 在 ST 的聊天保存链路增加 mem0 写入（异步、失败不影响保存）
- 选择写入粒度（最近一轮/两轮），并增加内容过滤策略（避免噪声写入）
- 写入 payload 统一封装（`messages`、`user_id`、`agent_id`、`metadata`）

### 2.4 设置页（重写 prompt 管理）

- 在 ST 设置中新增“Mem0 Retrieval: Query Rewrite”配置区（开关 + 文本框）
- 配置存储与生效机制（保存后下一次 `/generate` 生效）
- 输出契约约束（只输出 query 文本），并在后端增加健壮解析/兜底

### 2.5 可观测与安全

- 为 mem0 调用增加最小化日志（仅耗时/状态码/是否命中，不记录敏感内容）
- 对外部服务调用统一超时与熔断（避免拖慢生成/保存）
- 确认密钥与连接串不落日志、不落前端

### 2.7 大模型配置管理（新增）

- **后端 (Mem0)**
  - 实现 `GET /models` 接口，返回预置/推荐的模型列表。
  - 实现 `POST /configure` 接口，支持热更新 `MEMORY_INSTANCE` 的 LLM 配置。
  - 增加配置更新的日志记录。

- **前端 (SillyTavern)**
  - 修改 `index.html`：在顶栏增加 `LLM` 按钮与配置面板 DOM 结构。
  - 新增 `llm-config.js`：
    - 实现点击按钮显隐面板逻辑。
    - 实现从后端拉取模型列表并填充下拉框。
    - 实现 Chat Model 变更时同步修改 ST 内部设置。
    - 实现 Memory Model 变更时调用 Mem0 `/configure` 接口。
  - 样式适配：确保面板符合 ST 主题风格。

### 2.8 验收与测试

- 增加最小集验收用例（明确问题/弱问句/跨天回忆/ mem0 故障降级）
- 增加接口契约回归（`/search`、`/memories` 的请求/响应结构）
- 校验长上下文与注入对 token 的影响（限制策略生效）

## 3. ADR（关键决策记录要点）

- ADR-001：是否允许修改上游 ST 源码（建议：优先插件化/最小 patch，保持可升级）
- ADR-002：记忆注入位置（system 追加 vs 新增 role/自定义段）
- ADR-003：隔离策略（`agent_id` 取角色名/角色文件名/聊天 id 的权衡）
- ADR-004：重写模型与成本控制（默认关闭，仅 fallback）

## 4. 风险清单（摘录）

- 弱问句重写引入成本与延迟（默认关闭、只在 fallback、严格超时）
- 记忆注入过长影响上下文（topK/长度限制/去重）
- 上游升级冲突（改动集中、feature flag、记录差异）
